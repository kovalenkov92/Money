(function () {

  "use strict";

  angular.module('main').controller('IndexCtrl', [ '$scope', '$state', 'CategoriesFactory', 'BalanceFactory', 'TransactionsFactory', '$modal',
    function($scope, $state, categories, balance, transactions, $uibModal) {

      var getBalance = function() {
        balance.getBalance()
          .success(function(data) {
            $scope.balance = data.balance;
          })
      };
      getBalance();

      var getCategories = function() {
        categories.all()
          .success(function(data) {
            $scope.categories = data.categories;
          })
      };
      getCategories();

      $scope.addCategory = function() {
          var modalInstance = $uibModal.open({
            animation: true,
            templateUrl: "<%= asset_path('application/templates/modals/new-category-modal.html') %>",
            controller: ['$scope', '$http', '$modalInstance', function($scope, $http, $modalInstance) {

                $scope.ok = function (name) {
                categories.createCategory(name)
                  .success(function(data) {
                    $modalInstance.close();
                    getCategories();
                  })
                  .error(function(data) {
                    $scope.errors = data.errors;
                  })
                };

                $scope.cancel = function () {
                $modalInstance.dismiss('cancel');
                };
            }],
          });         
      };

      var getTransactions = function() {
        transactions.all()
          .success(function(data) {
            $scope.transactions = data.transactions;
          })
          .error(function(data) {
            console.log(data);
          })
      };
      getTransactions();

      $scope.fixOutgo = function(value, category, comment) {
        $scope.transaction_errors = false;
        
        if (!category) {
          category = null;
        }else{
          category = category.id;
        }

        value = - value;

        transactions.createTransaction(value, category, comment)
          .success(function(data) {
            getBalance();
            getCategories();
            getTransactions();
          })
          .error(function(data) {
            console.log(data);
            $scope.transaction_errors = data.errors;
          });
      };

      $scope.fixIncome = function(value, category, comment) {

        if (!category) {
          category = null;
        }else{
          category = category.id;
        }
        
        transactions.createTransaction(value, category, comment)
          .success(function(data) {
            getBalance();
            getCategories();
            getTransactions();
          })
          .error(function(data) {
            console.log(data);
            $scope.transaction_errors = data.errors;
          });
      };

      $scope.removeTransaction = function(id) {
        transactions.deleteTransaction(id)
          .success(function(data) {
            getBalance();
            getCategories();
            getTransactions();
          })
          .error(function(data) {
            console.log(data);
          })
      };

    }])
}());